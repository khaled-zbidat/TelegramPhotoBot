name: Deploy PolyBot to Dev

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          cat > ~/.ssh/config << EOF
          Host server
            HostName ${{ secrets.DEV_EC2_HOST }}
            User ${{ secrets.EC2_USERNAME }}
            IdentityFile ~/.ssh/key
            StrictHostKeyChecking no
          EOF

      - name: Deploy to DEV server
        run: |
          ssh server "
            echo 'ðŸš€ Deploying to DEV environment...'
            
            # Clone or update repo on DEV branch
            if [ -d ~/TelegramPhotoBot ]; then
              echo 'ðŸ“‚ Updating existing repository...'
              cd ~/TelegramPhotoBot
              git fetch origin
              git stash push -m 'Auto-stash before deploy'
              git checkout dev
              git reset --hard origin/dev
              echo 'âœ… Updated to latest dev branch'
            else
              echo 'ðŸ“¥ Cloning dev branch...'
              git clone -b dev ${{ github.server_url }}/${{ github.repository }}.git ~/TelegramPhotoBot
              echo 'âœ… Cloned dev branch'
            fi
            
            cd ~/TelegramPhotoBot
            echo 'ðŸ“Œ Current branch:'
            git branch --show-current
            git log -1 --oneline
            
            # Make scripts executable
            chmod +x setup.sh
            chmod +x polybot/start_dev.sh
            
            # Run setup for DEV environment (from main directory)
            echo 'ðŸ”§ Running DEV setup...'
            ./setup.sh
            
            # Start the bot with DEV configuration (from polybot directory)
            echo 'ðŸš€ Starting DEV bot...'
            cd polybot
            ./start_dev.sh '${{ secrets.TELEGRAM_TOKEN }}' '${{ secrets.YOLO_URL_DEV }}' '${{ secrets.YOUR_NGROK_TOKEN }}'
            
            echo 'âœ… DEV deployment complete!'
          "